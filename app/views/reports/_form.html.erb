<%= assets_manifest.find_sources("fine-uploader/simple-thumbnails.html").first.html_safe %><br>

<%= simple_form_for(@report, :wrapper => :horizontal_form) do |f| %>
  <%= f.error_notification %>

  <p><abbr title="required">*</abbr> Required field</p>

  <div class="form-horizontal">
    <%= f.input :property_name %>
    <%= f.input :monitoring_year, :collection => monitoring_year_options(@report), :input_html => { :class => "form-control-inline" } %>
    <%= f.input :photographer_name %>
    <% if(!@report.new_record?) %>
      <div class="form-group">
        <div class="col-sm-offset-3 col-sm-9">
          <%= link_to('<F28><span class="glyphicon glyphicon-plus" aria-hidden="true"></span>Add additional new photos'.html_safe, "#", :id => "uploader_toggle") %>
        </div>
      </div>
    <% end %>
    <div class="form-group" id="uploader_container" style="<%= "display: none" if(!@report.new_record?) %>">
      <div class="col-sm-3 control-label">
        <label for="property"><abbr title="required">*</abbr> Photos</label>
        <span class="help-block">Upload either JPEG files or KMZ files.</span>
      </div>
      <div class="col-sm-9">
        <div id="uploader"></div>
        <div id="uploader_uuids">
          <% if(@report.upload_uuids) %>
            <% @report.upload_uuids.each do |uuid| %>
              <%= f.hidden_field(:upload_uuids, :multiple => true, :value => uuid) %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <script>
      setupUploader('uploader', 'report[upload_uuids][]');
    </script>
  </div>

  <% unless(@report.new_record?) %>
    <%= f.simple_fields_for(:photos, :wrapper => :inline_form) do |pf| %>
      <% next unless(pf.object.persisted?) %>
      <div class="row form-group">
        <div class="col-sm-3 text-center">
          <%= attachment_image_tag(pf.object, :image, :limit, 200, 200, :class => "img-responsive center-block") %>
          <%= link_to("Download original", download_photo_path(pf.object)) %><br>
          <%= link_to("Replace photo", "#", :id => "uploader_#{pf.object.id}_toggle") %>
          <div id="uploader_<%= pf.object.id %>_container" style="display: none;">
            <div id="uploader_<%= pf.object.id %>"></div>
            <div id="uploader_<%= pf.object.id %>_uuids"></div>
          </div>
          <script>
            setupUploader('uploader_<%= pf.object.id %>', 'report[photos_attributes][<%= pf.options[:child_index] %>][upload_uuid]', {
              multiple: false,
              validation: {
                allowedExtensions: ['jpg', 'jpeg'],
              },
            });
          </script>
        </div>
        <div class="col-sm-6"><%= pf.input(:caption, :as => :text, :input_html => { :rows => 5 }) %></div>
        <div class="col-sm-3">
          <%= render("photo_metadata", :photo => pf.object) %>
          <%= pf.input(:_destroy, :as => :boolean) %>
        </div>
      </div>
    <% end %>
  <% end %>

  <div class="row submit">
    <div class="col-sm-12 text-center">
      <%= f.button :button, :class => "btn-lg btn-primary", "data-after-submit-text" => '<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> Saving...'.html_safe %>
      <%= link_to("Cancel", :back, :class => "text-danger cancel") %>
    </div>
  </div>
<% end %>

<script>
  $('form').dirtyForms();

  $(document).on('submit', 'form', function() {
    var $form = $(this);
    $form.find(':submit').each(function() {
      $button = $(this);
      label = $button.data('after-submit-text');
      if(label) {
        $button.html(label).prop('disabled', true);
      }
    });
  });
</script>
