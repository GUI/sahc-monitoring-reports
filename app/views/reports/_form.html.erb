<%= assets_manifest.find_sources("fine-uploader/simple-thumbnails.html").first.html_safe %><br>

<% @report.set_default_empty_extra_signatures! %>
<%= simple_form_for(@report, :wrapper => :horizontal_form, :wrapper_mappings => { :radio_buttons => :horizontal_radio_and_checkboxes }) do |f| %>
  <%= render("/form_errors", :record => @report) %>

  <p><abbr title="required">*</abbr> Required field</p>

  <div class="form-horizontal">
    <%= f.input :type, :as => :radio_buttons, :collection => Report::TYPES.invert %>
    <%= f.input :property_name %>
    <%= f.input :monitoring_year, :collection => monitoring_year_options(@report), :input_html => { :class => "form-control-inline" } %>
    <%= f.input :photographer_name %>
    <%= f.input :extra_signatures, :as => :array %>
    <% if(@report.photos.present?) %>
      <div class="form-group" id="uploader_toggle">
        <div class="col-sm-offset-4 col-sm-8">
          <%= link_to('<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>Add additional new photos'.html_safe, "#") %>
        </div>
      </div>
    <% end %>
    <div class="form-group" id="uploader_container" style="<%= "display: none" if(@report.photos.present?) %>">
      <div class="col-sm-4 control-label">
        <label for="property"><abbr title="required">*</abbr> Photos</label>
        <span class="help-block">Upload either JPEG files or KMZ files.</span>
      </div>
      <div class="col-sm-8">
        <div id="uploader"></div>
        <div id="uploader_uuids">
          <% if(@report.upload_uuids) %>
            <% @report.upload_uuids.each do |uuid| %>
              <%= f.hidden_field(:upload_uuids, :multiple => true, :value => uuid) %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <script>
      setupUploader('uploader', 'report[upload_uuids][]');
    </script>
  </div>

  <% photo_num = 1 %>
  <% unless(@report.new_record?) %>
    <%= f.simple_fields_for(:photos, :wrapper => :inline_form) do |pf| %>
      <% next unless(pf.object.persisted?) %>
      <div class="row form-group photo-form">
        <div class="col-sm-4 text-center">
          <% if(pf.object.image? && pf.object.image.file.last_modified) %>
            <%= image_tag(pf.object.image.thumbnail.url, :class => "img-responsive center-block") %>
            <div class="photo-num">Photo <%= photo_num %></div>
            <%= link_to("Download original", "#{pf.object.image.url}?download=true") %><br>
          <% else %>
            <em>Missing photo</em><br>
          <% end %>
          <div id="uploader_<%= pf.object.id %>_toggle">
            <%= link_to("Replace photo", "#") %>
          </div>
          <div id="uploader_<%= pf.object.id %>_container" style="display: none;">
            <div id="uploader_<%= pf.object.id %>"></div>
            <div id="uploader_<%= pf.object.id %>_uuids"></div>
          </div>
          <script>
            setupUploader('uploader_<%= pf.object.id %>', 'report[photos_attributes][<%= pf.options[:child_index] %>][upload_uuid]', {
              multiple: false,
              validation: {
                allowedExtensions: ['jpg', 'jpeg'],
              },
            });
          </script>
        </div>
        <div class="col-sm-5"><%= pf.input(:caption, :as => :text, :input_html => { :rows => 8 }) %></div>
        <div class="col-sm-3">
          <%= render("photo_metadata", :photo => pf.object) %>
          <%= pf.input(:_destroy, :as => :boolean) %>
        </div>
      </div>
      <% photo_num += 1 %>
    <% end %>
  <% end %>

  <div class="row submit">
    <div class="col-sm-12 text-center">
      <%= f.button :button, :class => "btn-lg btn-primary", "data-after-submit-text" => '<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> Saving...'.html_safe %>
      <%= link_to("Cancel", :back, :class => "text-danger cancel") %>
    </div>
  </div>
<% end %>

<script>
  $('form').dirtyForms();

  $(document).on('submit', 'form', function() {
    var $form = $(this);
    $form.find(':submit').each(function() {
      $button = $(this);
      label = $button.data('after-submit-text');
      if(label) {
        $button.html(label).prop('disabled', true);
      }
    });
  });


  var $arrayContainer = $('.form-group.array .control-input')
  function appendArrayElement() {
    if($arrayContainer.find('input:last-child').val() !== '') {
      var $newElement = $('.form-group.array input:last-child').clone();
      $newElement.val('');
      $arrayContainer.append($newElement);
    }
  }
  appendArrayElement();
  $arrayContainer.on('keyup', 'input', appendArrayElement);
</script>
